name: FullTest

on:
  workflow_dispatch:

concurrency:
  group: fulltest
  cancel-in-progress: true

jobs:
  fulltest:
    runs-on: [self-hosted, Windows, X64, gpu]
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: FullTest (MP4 input only)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $PY = "F:\Root\venv\Scripts\python.exe"
          if (!(Test-Path $PY)) { throw "Venv python yok: $PY" }

          $MP4 = "F:\test\full_test.mp4"
          if (!(Test-Path $MP4)) { throw "full_test.mp4 yok: $MP4" }

          $ff = Get-Command ffmpeg -ErrorAction SilentlyContinue
          if (-not $ff) { throw "ffmpeg bulunamadı (PATH'te olmalı)" }

          New-Item -ItemType Directory -Force artifacts | Out-Null
          $WAV = (Resolve-Path ".\artifacts").Path + "\full_test.wav"

          # MP4'ten geçici WAV çıkar (harici wav şart değil)
          & ffmpeg -hide_banner -loglevel error -y -i "$MP4" -vn -ac 1 -ar 16000 -t 60 "$WAV"
          if ($LASTEXITCODE -ne 0) { throw "ffmpeg audio extract failed" }

          & $PY -m compileall Project

          & $PY Project\tests\asr_smoke.py --wav "$WAV" --out artifacts\asr_smoke.json
          & $PY Project\tests\video_smoke.py --video "$MP4" --out artifacts\video_smoke.json

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fulltest-artifacts
          path: artifacts